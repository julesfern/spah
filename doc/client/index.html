<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Spah  v0.0.0 API documentation | Home</title>
  <meta name="generator" content="PDoc" />
  
  <script charset="utf-8" src="javascripts/pdoc/prototype.js" type="text/javascript"></script>
  <script charset="utf-8" src="javascripts/pdoc/application.js" type="text/javascript"></script>
<script charset="utf-8" src="javascripts/pdoc/tabs.js" type="text/javascript"></script>
  <script charset="utf-8" src="javascripts/pdoc/item_index.js" type="text/javascript"></script>
  
  <link charset="utf-8" href="stylesheets/pdoc/api.css" media="screen, projection" rel="stylesheet" type="text/css" />
<link charset="utf-8" href="stylesheets/pdoc/pygments.css" media="screen, projection" rel="stylesheet" type="text/css" />
  
  <script type="text/javascript">
    PDoc.pathPrefix = '';
  </script>
</head>
  <body>

    <div id="sidebar">
      <ul id="sidebar_tabs" class="sidebar-tabs">
        <li>
          <a href="#menu_pane">Menu</a>
        </li>
        <li>
          <a href="#search_pane">Search</a>
        </li>
      </ul> <!-- .sidebar-tabs -->

      <form class="search-ribbon">
        <label>
          <span class="hidden">Search</span>
          <input type="text" id="search" size="20" title="Search" />
        </label>
      </form>
      
      <div class="sidebar-pane scrollable" id="menu_pane">
        <ul class="menu-items" id="api_menu"><li><div class="menu-item"><a class="class" href="Spah/index.html" title="Spah (class)">Spah</a></div><ul><li><div class="menu-item"><a class="class" href="Spah/State/index.html" title="Spah.State (class)">Spah.State</a></div><ul><li><div class="menu-item"><a class="class" href="Spah/State/DataHelper/index.html" title="Spah.State.DataHelper (class)">Spah.State.DataHelper</a></div></li></ul></li></ul></li></ul><!--- #api_menu =-->
      </div> <!-- .sidebar-pane -->
      <div class="sidebar-pane" id="search_pane">
        <ul id="search_results" class="search-results menu-items scrollable"></ul>
      </div> <!-- .sidebar-pane -->
    </div> <!-- #sidebar -->

    <div id="page">
      

      <div id="main" class="page-content">
        

<div class="page-introduction">
  <h1 id='spah_singlepage_application_helper'>Spah: Single-Page Application Helper</h1>
<img src='https://img.skitch.com/20110504-c79qr916mcwtnq4m63uqc3dibq.jpg' />
<h1 id='contents'>Contents</h1>

<ol>
<li>
<p><a href='#introduction'>Introduction</a></p>
</li>

<li>
<p><a href='#the_server'>The server</a></p>
</li>

<li>
<p><a href='#the_client'>The client</a></p>
</li>

<li>
<p><a href='#state_queries'>State queries</a></p>

<ul>
<li><a href='#selection_queries'>Selection queries</a></li>

<li><a href='#boolean_queries'>Boolean queries</a></li>
</ul>
</li>

<li>
<p><a href='#document_logic'>Document logic</a></p>

<ul>
<li><a href='#hide_or_show_an_element'>Hiding and showing elements</a></li>

<li><a href='#add_or_remove_element_classes'>Adding and removing element classes</a></li>

<li><a href='#set_element_id'>Setting the ID of an element</a></li>

<li><a href='#stash_and_unstash_element_content'>Stash and unstash element content</a></li>

<li><a href='#using_multiple_operations_on_a_single_element'>Using multiple operations on a single element</a></li>

<li><a href='#advanced_document_logic_example'>Advanced example</a></li>
</ul>
</li>

<li>
<p>TODO: <a href='#templating_with_mustache'>Templating with Mustache</a></p>
</li>

<li>
<p>TODO: <a href='#you_can_still_write_your_markup_with_ruby'>Building your markup with ruby</a> (erb, haml, templating, url builders)</p>
</li>

<li>
<p>TODO: <a href='#responding_to_state_changes_with_javascript'>Reacting to state changes with Javascript</a></p>
</li>

<li>
<p><a href='#forcing_links_and_forms_to_load_synchronously'>Forcing links and forms to load synchronously</a></p>
</li>

<li>
<p>TODO: <a href='#default_client_behaviour'>Default client behaviours</a> (automatically update doc title from /title path, automatically add async behaviour, automatically manage history)</p>
</li>

<li>
<p>TODO: <a href='#eager_client_state_changes'>Eager client state changes</a> (mark parts of the tree as &#8220;expected to get new data&#8221; to trigger load notifications. automatically revert to previous state on load failure and dispatch failure event)</p>
</li>

<li>
<p>TODO: <a href='#example_rails_application'>Examples: Example Rails application</a></p>
</li>

<li>
<p>TODO: <a href='#example_sinatra_application'>Examples: Example Sinatra application</a></p>
</li>
</ol>

<h1 id='introduction'>Introduction</h1>

<p>Spah is both a server-side rubygem and a client-side javascript library. Together, the two parts are used to build dynamic single-page web applications that:</p>

<ul>
<li>Don&#8217;t break the web, and keep the document as king. With Spah, every resource may be curled, scraped and indexed just as with a static site.</li>

<li>Cold boot into full-fledged javascript applications from any of your application&#8217;s URLs.</li>

<li>Provide graceful continuation of interface state between pages when an action absolutely must be performed synchronously.</li>
</ul>

<p>The central concept in Spah is the <strong>state</strong>. Spah manages the state of your application as a hash which may contain more hashes, booleans, strings and arrays. You, as the developer of your application, define the overall structure of the state. As an example, the state for this documentation page might be something like:</p>
<div class='highlight'><pre> <span class='p'>{</span>
   <span class='s2'>&quot;class&quot;</span><span class='o'>:</span> <span class='s2'>&quot;Spah&quot;</span><span class='p'>,</span> <span class='c1'>// Currently viewing the Spah class</span>
   <span class='s2'>&quot;method&quot;</span><span class='o'>:</span> <span class='kc'>null</span><span class='p'>,</span> <span class='c1'>// No specific method selected</span>
   <span class='s2'>&quot;search-query&quot;</span><span class='o'>:</span> <span class='s2'>&quot;&quot;</span> <span class='c1'>// No search term entered in search box</span>
 <span class='p'>}</span>
</pre>
</div>
<p>On each request to the server, Spah will attach the state in JSON form to the request. The server modifies the state and returns a new JSON object containing the updates. The Spah client merges the updates into the state and dispatches events to which you may subscribe.</p>

<h1 id='the_server'>The server</h1>

<p>A Spah application is assumed to be a RESTish ruby application - in our examples we&#8217;ll be using Rails. As always, all validation and data persistence is handled by your models. All routing by the router, and all request logic in the controllers. Where a Spah app differs is in the view layer.</p>

<p><em>Figure 1: A crap approach to single-page apps</em></p>
<img src='https://img.skitch.com/20110504-73a3ftde7d731kbepxg2p7w1.jpg' />
<p>Instead of hiding away template logic in server-side ruby, template logic is moved to a place where both the client AND the server have access to it - <a href='#document_logic'>the document itself</a>.</p>

<p>A Spah HTML render takes the <strong>state</strong> and a <strong>prototype layout</strong> and gloms to the two together. The HTML layout contains <a href='#document_logic'>logic encoded in HTML5 data attributes</a>, and Spah will pre-process the document <strong>before sending it down the wire</strong>. This way, any view can be cold-rendered by a request to the appropriate URL, or warm-rendered by an asynchronous state update from the server. In a sense, Spah allows your server-side app to <em>behave like a browser</em> and boot your client-side application to the point of usefulness, before letting the user&#8217;s actual browser carry out the rest of the startup process.</p>

<p><em>Figure 2: A better approach.</em></p>
<img src='https://img.skitch.com/20110504-p13hfga9s4d6x7bpjwrw1gbyjj.jpg' />
<p>For partials, Spah uses <a href='#templating_with_mustache'>Mustache templates</a>. All <code>.mustache</code> files in your server-side application are indexed by path on startup and made available to the rendering chain on both the client and server. Spah automatically injects the templates into your HTML layout using script tags:</p>
<div class='highlight'><pre><span class='nt'>&lt;script </span><span class='na'>type=</span><span class='s'>&quot;text/mustache&quot;</span> <span class='na'>id=</span><span class='s'>&quot;views/my/partial&quot;</span><span class='nt'>&gt;</span>
  <span class='p'>{{</span><span class='nx'>name</span><span class='p'>}}</span>
<span class='nt'>&lt;/script&gt;</span>
</pre>
</div>
<p>These are semantically neutral in nature and do not alter your document&#8217;s content. Spah will also add a hidden <code>state</code> input to the end of each form in your document containing the current state, and append the state to link URLs within the current domain - this allows for graceful state handover in no-js environments.</p>

<p>In environments that support JS, the state in forms and links is replaced with the current state on submission/activation.</p>

<h1 id='the_client'>The client</h1>

<p>The Spah client handles things at the browser end. Its primary tasks are:</p>

<ol>
<li>Ensuring that links and forms are submitted asynchronously and that they attach the state when activated (you may also <a href='#forcing_links_and_forms_to_load_synchronously'>prevent some links and forms from acting asynchronously</a>)</li>

<li>Ensuring that async requests are submitted with a <code>content-accept</code> header of <code>application/state+json</code>, allowing the server-side application to determine that this is a warm request and should be responded to with an updated state</li>

<li>Re-evaluating and processing any document logic whenever the state is modified</li>

<li>Raising path-specific events whenever the state is modified</li>
</ol>

<p><em>Figure 3: A better approach, with added progressive enhancement</em></p>
<img src='https://img.skitch.com/20110504-tpqb613eyy46j7f758nqr745n2.jpg' />
<p>For cleanliness, Spah keeps all of its functions, classes and behaviour within the top level <code>Spah</code> object. Initialising Spah is simple:</p>
<div class='highlight'><pre> <span class='nx'>$</span><span class='p'>(</span><span class='nb'>document</span><span class='p'>).</span><span class='nx'>ready</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span> 
     <span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>init</span><span class='p'>();</span> 
 <span class='p'>});</span>
</pre>
</div>
<p>This is achieved by embedding template logic within the markup using HTML5 data attributes, thus making the same template logic available to both client and server. When the state is updated by a response from the server, elements with embedded display logic are re-evaluated automatically and the display updated accordingly.</p>

<p>You may also bind more advanced behaviours to changes in the state using <a href='#responding_to_state_changes_with_javascript'>jQuery responders</a> and <a href='#state_queries'>state queries</a></p>

<h1 id='state_queries'>State queries</h1>

<h2 id='selection_queries'>Selection Queries</h2>

<p>The state may be queried on both the client and server by using the state query language, a DSL for querying JSON structures. Let&#8217;s take an example state with a variety of types:</p>
<div class='highlight'><pre><span class='p'>{</span>
  <span class='nx'>hash_one</span><span class='o'>:</span> <span class='p'>{</span><span class='nx'>foo</span><span class='o'>:</span> <span class='s2'>&quot;bar&quot;</span><span class='p'>,</span> <span class='nx'>bar</span><span class='o'>:</span> <span class='s2'>&quot;baz&quot;</span><span class='p'>,</span> <span class='nx'>hash_in_hash</span><span class='o'>:</span> <span class='p'>{</span><span class='s2'>&quot;foo&quot;</span><span class='o'>:</span> <span class='s2'>&quot;bar-inner&quot;</span><span class='p'>}},</span>
  <span class='nx'>hash_two</span><span class='o'>:</span> <span class='p'>{</span><span class='nx'>foo</span><span class='o'>:</span> <span class='s2'>&quot;bar&quot;</span><span class='p'>,</span> <span class='nx'>bool_one</span><span class='o'>:</span> <span class='kc'>true</span><span class='p'>,</span> <span class='nx'>bool_two</span><span class='o'>:</span> <span class='kc'>false</span><span class='p'>,</span> <span class='nx'>arr_in_hash</span><span class='o'>:</span> <span class='p'>[</span><span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span><span class='p'>,</span><span class='mi'>3</span><span class='p'>]},</span>
  <span class='nx'>arr_one</span><span class='o'>:</span> <span class='p'>[</span><span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span><span class='p'>,</span><span class='mi'>3</span><span class='p'>],</span>
  <span class='nx'>arr_two</span><span class='o'>:</span> <span class='p'>[</span><span class='mi'>0</span><span class='p'>,</span><span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span><span class='p'>],</span>
  <span class='nx'>arr_three</span><span class='o'>:</span> <span class='p'>[],</span>
  <span class='nx'>bool_one</span><span class='o'>:</span> <span class='kc'>true</span><span class='p'>,</span>
  <span class='nx'>bool_two</span><span class='o'>:</span> <span class='kc'>false</span>
<span class='p'>}</span>
</pre>
</div>
<p>You may retrieve any value using a simple path:</p>
<div class='highlight'><pre><span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>selectValues</span><span class='p'>(</span><span class='s2'>&quot;/hash_one&quot;</span><span class='p'>);</span> <span class='c1'>//-&gt; [{foo: &quot;bar&quot;, bar: &quot;baz&quot;}]</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>selectValues</span><span class='p'>(</span><span class='s2'>&quot;/hash_one/foo&quot;</span><span class='p'>);</span> <span class='c1'>//-&gt; &quot;bar&quot;;</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>selectValues</span><span class='p'>(</span><span class='s2'>&quot;/hash_one/arr_in_hash&quot;</span><span class='p'>);</span> <span class='c1'>//-&gt; &quot;bar&quot;;</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>selectValues</span><span class='p'>(</span><span class='s2'>&quot;//foo&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; [&quot;bar&quot;, &quot;bar&quot;];</span>
</pre>
</div>
<p>In the last example, a double slash is used to indicate that we want all values named &#8220;foo&#8221; regardless of their place in the hierarchy. Much like xpath, the query can be scoped:</p>
<div class='highlight'><pre><span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>selectValues</span><span class='p'>(</span><span class='s2'>&quot;/hash_one//foo&quot;</span><span class='p'>);</span> <span class='c1'>//-&gt; [&quot;bar&quot;, &quot;bar-inner&quot;];</span>
</pre>
</div>
<p>What is actually happening here is that the #selectValues method is getting a set of <code>Spah.Viewstate.select.Result</code> objects back, each of which provides a path and a value for the returned result:</p>
<div class='highlight'><pre><span class='kd'>var</span> <span class='nx'>results</span> <span class='o'>=</span> <span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s2'>&quot;/hash_one//foo&quot;</span><span class='p'>);</span> <span class='c1'>//-&gt; [Result, Result];</span>
    <span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>path</span> <span class='c1'>//-&gt; &quot;/hash_one/foo&quot;</span>
    <span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>value</span> <span class='c1'>//-&gt; &quot;bar&quot;</span>
    <span class='nx'>results</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>].</span><span class='nx'>path</span> <span class='c1'>//-&gt; &quot;/hash_one/hash_in_hash/foo&quot;</span>
    <span class='nx'>results</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>].</span><span class='nx'>value</span> <span class='c1'>//-&gt; &quot;bar-inner&quot;</span>
</pre>
</div>
<p>When accessing arrays, strings and hashes, the <code>[index]</code> accessor may be used:</p>
<div class='highlight'><pre><span class='c1'>// Array</span>
<span class='nx'>results</span> <span class='o'>=</span> <span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s2'>&quot;/arr_one[0]&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; [Result]</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>path</span> <span class='c1'>//-&gt; &quot;/arr_one[0]&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>value</span> <span class='c1'>//-&gt; 1</span>

<span class='c1'>// Hash</span>
<span class='nx'>results</span> <span class='o'>=</span> <span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s2'>&quot;/hash_one[foo]&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; [Result]</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>path</span> <span class='c1'>//-&gt; &quot;/hash_one/foo&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>value</span> <span class='c1'>//-&gt; &quot;bar&quot;</span>

<span class='c1'>// String</span>
<span class='nx'>results</span> <span class='o'>=</span> <span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s2'>&quot;/hash_one/foo[1]&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; [Result]</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>path</span> <span class='c1'>//-&gt; &quot;/hash_one/foo[1]&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>value</span> <span class='c1'>//-&gt; &quot;a&quot;</span>
</pre>
</div>
<p>Arrays, strings and hashes also provide the .length property:</p>
<div class='highlight'><pre><span class='nx'>results</span> <span class='o'>=</span> <span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s2'>&quot;/arr_one.length&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; [Result]</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>path</span> <span class='c1'>//-&gt; &quot;/arr_one.length&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>].</span><span class='nx'>value</span> <span class='o'>=</span> <span class='mi'>3</span>
</pre>
</div>
<p>Arrays provide the .first and .last properties:</p>
<div class='highlight'><pre><span class='nx'>results</span> <span class='o'>=</span> <span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s2'>&quot;/arr_one.first&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; [Result]</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>path</span> <span class='c1'>//-&gt; &quot;/arr_one[0]&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>value</span> <span class='o'>=</span> <span class='mi'>1</span>

<span class='nx'>results</span> <span class='o'>=</span> <span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s2'>&quot;/arr_one.last&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; [Result]</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>path</span> <span class='c1'>//-&gt; &quot;/arr_one[2]&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>value</span> <span class='o'>=</span> <span class='mi'>3</span>
</pre>
</div>
<p>The <code>[]</code> accessor also supports comparators:</p>
<div class='highlight'><pre><span class='c1'>// Query for all hashes where the &quot;foo&quot; property is defined </span>
<span class='c1'>// and has value &quot;bar&quot;:</span>
<span class='nx'>results</span> <span class='o'>=</span> <span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s2'>&quot;//[foo==&#39;bar&#39;]&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; [Result, Result]</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>path</span> <span class='o'>=</span> <span class='s2'>&quot;/hash_one/foo&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>value</span> <span class='o'>=</span> <span class='s2'>&quot;bar&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>].</span><span class='nx'>path</span> <span class='o'>=</span> <span class='s2'>&quot;/hash_two/foo&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>].</span><span class='nx'>value</span> <span class='o'>=</span> <span class='s2'>&quot;bar&quot;</span>
    
<span class='c1'>// Query for all hashes where the &quot;foo&quot; property is defined and </span>
<span class='c1'>// has a value matching the regular expression &#39;^bar&#39;</span>
<span class='nx'>results</span> <span class='o'>=</span> <span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s2'>&quot;//[foo~=&#39;^bar&#39;]&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; </span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>]</span>

<span class='c1'>// Query for all arrays of at least 2 entries in length:</span>
<span class='c1'>// Note that the &quot;type&quot; and &quot;length&quot; properties are preceded by a dot.</span>
<span class='c1'>// Available types are &quot;Array&quot;, &quot;Bool&quot;, &quot;Hash&quot;, &quot;String&quot;</span>
<span class='nx'>results</span> <span class='o'>=</span> <span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s2'>&quot;//[.type==&#39;Array&#39; &amp;&amp; .length&gt;=2]&quot;</span><span class='p'>)</span> 
<span class='c1'>// -&gt; [Result, Result, Result]</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>path</span> <span class='o'>=</span> <span class='s2'>&quot;/hash_two/arr_in_hash&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>value</span> <span class='o'>=</span> <span class='p'>[</span><span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span><span class='p'>,</span><span class='mi'>3</span><span class='p'>]</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>].</span><span class='nx'>path</span> <span class='o'>=</span> <span class='s2'>&quot;/arr_one&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>].</span><span class='nx'>value</span> <span class='o'>=</span> <span class='p'>[</span><span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span><span class='p'>,</span><span class='mi'>3</span><span class='p'>]</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>2</span><span class='p'>].</span><span class='nx'>path</span> <span class='o'>=</span> <span class='s2'>&quot;/arr_two&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>2</span><span class='p'>].</span><span class='nx'>value</span> <span class='o'>=</span> <span class='p'>[</span><span class='mi'>0</span><span class='p'>,</span><span class='mi'>1</span><span class='p'>,</span><span class='mi'>2</span><span class='p'>]</span>

<span class='c1'>// Query for all hashes where the value of key &quot;foo&quot; matches the value found </span>
<span class='c1'>// at /hash_one/foo</span>
<span class='c1'>// NOTE: If the subquery returns more than one Result then an exception will be </span>
<span class='c1'>// raised. Be sure to use specific address paths in comparison operations.</span>
<span class='nx'>results</span> <span class='o'>=</span> <span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s2'>&quot;//[foo==/hash_one/foo]&quot;</span><span class='p'>)</span> <span class='o'>-&gt;</span> <span class='p'>[</span><span class='nx'>Result</span><span class='p'>,</span> <span class='nx'>Result</span><span class='p'>]</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>path</span> <span class='o'>=</span> <span class='s2'>&quot;/hash_one/foo&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>].</span><span class='nx'>value</span> <span class='o'>=</span> <span class='s2'>&quot;bar&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>].</span><span class='nx'>path</span> <span class='o'>=</span> <span class='s2'>&quot;/hash_two/foo&quot;</span>
<span class='nx'>results</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>].</span><span class='nx'>value</span> <span class='o'>=</span> <span class='s2'>&quot;bar&quot;</span>
</pre>
</div>
<h2 id='boolean_queries'>Boolean Queries</h2>

<p>Queries may also produce boolean results, using comparators between subqueries:</p>
<div class='highlight'><pre><span class='c1'>// Does the value at /hash_one/foo equal &quot;bar&quot;?</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/hash_one/foo == &#39;bar&#39;&quot;</span><span class='p'>)</span> 
<span class='c1'>//-&gt; true. The value is &quot;bar&quot;</span>

<span class='c1'>// Does the value at /hash_one/foo match the value at /hash_two/foo?</span>
<span class='c1'>// NOTE: if comparing the results of more than one query, the results of both </span>
<span class='c1'>// queries must be the same length and must have matching values </span>
<span class='c1'>// although the results DO NOT have to be from the same paths.</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/hash_one/foo == /hash_two/foo&quot;</span><span class='p'>)</span> 
<span class='c1'>//-&gt; true. Both values are &quot;bar&quot;</span>

<span class='c1'>// Is the value at /hash_one an array?</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/hash_one.type == &#39;Array&#39;&quot;</span><span class='p'>)</span> 
<span class='c1'>//-&gt; false. /hash_one is &#39;Hash&#39;</span>

<span class='c1'>// Is arr_one empty?</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/arr_one.length &lt; 1&quot;</span><span class='p'>)</span> 
<span class='c1'>//-&gt; false. /arr_one has 3 entries.</span>

<span class='c1'>// Is does arr_three have the same number of entries as arr_one?</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>spate</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/arr_three.length == /arr_one.length&quot;</span><span class='p'>)</span> 
<span class='c1'>//-&gt; false. /arr_three is empty, but /arr_one has 3 items.</span>

<span class='c1'>// Comparing arrays and hashes: both entities must have the same contents</span>
<span class='c1'>// and the same keys in order to achieve equality.</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/hash_two/arr_in_hash == /arr_one&quot;</span><span class='p'>)</span> 
<span class='c1'>//-&gt; true! both arrays have the same contents in the same order.</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/hash_two/arr_in_hash == /arr_two&quot;</span><span class='p'>)</span> 
<span class='c1'>//-&gt; false. each array has content distinct from the other.</span>

<span class='c1'>// Comparing the types of entities</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/hash_one.type == /hash_two.type&quot;</span><span class='p'>)</span> 
<span class='c1'>//-&gt; true. Both are hashes.</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/hash_one === /hash_two&quot;</span><span class='p'>)</span> 
<span class='c1'>// -&gt; true, functionally identical to the above</span>

<span class='c1'>// Comparing query result counts: use the #count property </span>
<span class='c1'>// at the end of your query</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/hash_one[foo~=&#39;bar&#39;]#count &gt; 3&quot;</span><span class='p'>)</span> 
<span class='c1'>//-&gt; false. There&#39;s only one item returned by this query.</span>
      
<span class='c1'>// And of course, simple truthiness assertions:</span>
<span class='c1'>// Basic assertions return true if the associated query returns &gt;0 results </span>
<span class='c1'>// and if any of those results have values other than false or null.</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/bool_one&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; true</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/bool_two&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; false</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/key_does_not_exist&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; false</span>
<span class='nx'>Spah</span><span class='p'>.</span><span class='nx'>state</span><span class='p'>.</span><span class='nx'>assert</span><span class='p'>(</span><span class='s2'>&quot;/arr_one&quot;</span><span class='p'>)</span> <span class='c1'>//-&gt; true</span>
</pre>
</div>
<h1 id='document_logic'>Document logic</h1>

<p>In a Spah application, document logic (show this, hide that, populate this with that) is moved away from in-place Erb views and into a place where both the client and the server will have access to it - the document itself. In doing this, we want to avoid doing anything silly like adding new tags or attributes that break HTML validity, or dirtying up your markup with billions of extra nested div elements.</p>

<p>Spah handles document logic with HTML5 data attributes. Elements may query the state and declare how they should be altered when the query result is returned. When cold-booting your application from the server, the document logic is evaluated and run in-place before sending the HTML down the wire - this is what allows Spah to respond to HTML requests with valid, useful documents. On the client side, updates to the state cause any embedded document logic to be re-evaluated automatically. All document logic is achieved using <a href='#state_queries'>State Queries</a>. Conditions such as <code>if</code> statements use truthiness queries, as seen in the <a href='#boolean_queries'>state query documentation</a>.</p>

<p>Spah provides the following operations on document logic:</p>

<h2 id='hide_or_show_an_element'>Hide or show an element</h2>

<p>Show/hide of an element is achieved by appending <code>display: none;</code> to the element&#8217;s <code>style</code> attribute if it should be hidden.</p>
<div class='highlight'><pre><span class='nt'>&lt;form</span> <span class='na'>class=</span><span class='s'>&quot;add-tags&quot;</span> <span class='na'>data-show-if=</span><span class='s'>&quot;/user-authenticated&quot;</span><span class='nt'>&gt;</span>
  This form will only show if the query &quot;/user-authenticated&quot; returns true
<span class='nt'>&lt;/form&gt;</span>

<span class='nt'>&lt;form</span> <span class='na'>class=</span><span class='s'>&quot;add-tags&quot;</span> <span class='na'>data-show-unless=</span><span class='s'>&quot;/user-anonymous&quot;</span><span class='nt'>&gt;</span>
  An alternative way of expressing a similar query using 
  the &quot;data-*-unless&quot; syntax. All conditions support both 
  the -if and -unless syntaxes.
<span class='nt'>&lt;/form&gt;</span>
</pre>
</div>
<h2 id='add_or_remove_element_classes'>Add or remove element classes</h2>

<p>Use the <code>data-class-[classname]-if</code> or <code>-unless</code> attribute to specify that a specific class should be appended to the element&#8217;s <code>class</code> attribute. language:html</p>

<pre><code>&lt;li class=&quot;item&quot; data-class-current-if=&quot;/items[0]/important&quot;&gt;
  This list item will have the class &quot;important&quot; if the first item in the 
  array at &quot;/items&quot; has the &quot;important&quot; property
&lt;/li&gt;</code></pre>

<h2 id='set_element_id'>Set element ID</h2>

<p>Use the <code>data-id-[id]-if</code> or <code>-unless</code> to specify that an element should be given a new <code>id</code> under certain circumstances. If the condition causes Spah to write the ID on an element, Spah will automatically remove the ID from any other elements that previously possessed it.</p>
<div class='highlight'><pre><span class='nt'>&lt;li</span> <span class='na'>class=</span><span class='s'>&quot;item&quot;</span> <span class='na'>data-id-current_item-if=</span><span class='s'>&quot;/items.last/id == 3&quot;</span><span class='nt'>&gt;</span>
  This list item will have the id &quot;current_item&quot; if the last object 
  in the items array has the property &quot;id&quot; with value 3.
<span class='nt'>&lt;/li&gt;</span>
</pre>
</div>
<h2 id='stash_and_unstash_element_content'>Stash and unstash element content</h2>

<p>Stashing content allows you to render semantically-null empty elements into your document, with their content stowed in a data attribute for later use. Stashing only occurs if there is no content already stashed on the element - thus stashed content may be used for state-toggling. See <a href='#advanced_document_logic_example'>example</a>.</p>
<div class='highlight'><pre><span class='nt'>&lt;div</span>  <span class='na'>class=</span><span class='s'>&quot;new-message-notification&quot;</span> 
      <span class='na'>data-stash-unless=</span><span class='s'>&quot;/messages[unread].length &gt; 0&quot;</span><span class='nt'>&gt;</span>
       You have new messages!
  
      (This text will be moved into the &quot;data-stashed-content&quot; attribute 
      on the containing DIV element if the user has no new messages. 
      This way, your markup won&#39;t contain a hidden, but erroneous, 
      new message notification.)
<span class='nt'>&lt;/div&gt;</span>

<span class='c'>&lt;!-- When the content is stashed, the element will look like this: --&gt;</span>
<span class='nt'>&lt;div</span>  <span class='na'>class=</span><span class='s'>&quot;new-message-notification&quot;</span> 
      <span class='na'>data-stash-unless=</span><span class='s'>&quot;/messages[unread].length &gt; 0&quot;</span> 
      <span class='na'>data-stashed-content=</span><span class='s'>&quot;You%20have%20new%20messages%21....&quot;</span><span class='nt'>&gt;</span>
<span class='nt'>&lt;/div&gt;</span>
</pre>
</div>
<h2 id='populate_element_from_a_template'>Populate element from a template</h2>

<p>Spah can use your shared <a href='#templating_with_mustache'>Mustache templates</a> to render state data into a containing element. On the client side, the Spah client will automatically add a <a href='#responding_to_state_changes_with_javascript'>jQuery responder</a> to the path referenced in the <code>data-populate-with</code> attribute, ensuring that the populated content is updated when the state is modified.</p>
<div class='highlight'><pre><span class='nt'>&lt;ul</span> <span class='na'>class=</span><span class='s'>&quot;users&quot;</span> <span class='na'>data-populate-if=</span><span class='s'>&quot;/users.length &gt; 0&quot;</span> 
                  <span class='na'>data-populate-with=</span><span class='s'>&quot;/users&quot;</span> 
                  <span class='na'>data-populate-template=</span><span class='s'>&quot;/views/users/single&quot;</span><span class='nt'>&gt;</span>
                 
  This text will be replaced with the results of running the template contained
  in an element with ID &quot;/views/users/single&quot; through Mustache.js using data from
  the state at /users as the payload.
  
  If the data found at /users is an array, the array will be wrapped in an object 
  so that Mustache can make it available: {&quot;items&quot;: [content, of, array]}
<span class='nt'>&lt;/ul&gt;</span>
</pre>
</div>
<h2 id='using_multiple_operations_on_a_single_element'>Using multiple operations on a single element</h2>

<p>All of the above operations may be combined on a single element. The order in which the operations will run is strictly defined in order of the type of operation. <code>-if</code> operations always run before <code>-unless</code> operations.</p>

<ol>
<li>data-show-if and data-show-unless</li>

<li>data-class-[classname]-if, data-class-[classname]-unless</li>

<li>data-id-[id]-if, data-id-[id]-unless</li>

<li>data-stash-if, data-stash-unless</li>

<li>data-populate-if, data-populate-unless</li>
</ol>

<h2 id='advanced_document_logic_example'>Advanced document logic example</h2>

<p>Let&#8217;s make an advanced example: We want a list of users to default to an &#8220;empty&#8221; state, becoming populated with users if there is a non-empty list of users in the state. If the user list in the state is emptied, then the &#8220;empty&#8221; state should be restored on the element</p>
<div class='highlight'><pre><span class='o'>&lt;</span><span class='nx'>ul</span> <span class='kr'>class</span><span class='o'>=</span><span class='s2'>&quot;users&quot;</span>
    <span class='nx'>data</span><span class='o'>-</span><span class='kr'>class</span><span class='o'>-</span><span class='nx'>empty</span><span class='o'>-</span><span class='k'>if</span><span class='o'>=</span><span class='s2'>&quot;/users.length &lt; 1&quot;</span><span class='o'>&gt;</span>
    <span class='nx'>data</span><span class='o'>-</span><span class='nx'>stash</span><span class='o'>-</span><span class='k'>if</span><span class='o'>=</span><span class='s2'>&quot;/users.length &gt; 0&quot;</span>
    <span class='nx'>data</span><span class='o'>-</span><span class='nx'>populate</span><span class='o'>-</span><span class='k'>if</span><span class='o'>=</span><span class='s2'>&quot;/users.length &gt; 0&quot;</span>
    <span class='nx'>data</span><span class='o'>-</span><span class='nx'>populate</span><span class='o'>-</span><span class='kd'>with</span><span class='o'>=</span><span class='s2'>&quot;/users&quot;</span>
    <span class='nx'>data</span><span class='o'>-</span><span class='nx'>populate</span><span class='o'>-</span><span class='nx'>template</span><span class='o'>=</span><span class='s2'>&quot;/views/users/single&quot;</span><span class='o'>&gt;</span>
    
    <span class='o'>&lt;</span><span class='nx'>li</span> <span class='kr'>class</span><span class='o'>=</span><span class='s2'>&quot;empty&quot;</span><span class='o'>&gt;</span>
      <span class='nx'>No</span> <span class='nx'>users</span> <span class='nx'>found</span><span class='p'>.</span>
    <span class='o'>&lt;</span><span class='err'>/li&gt;</span>
<span class='o'>&lt;</span><span class='err'>/ul&gt;</span>
</pre>
</div>
<p>Because stash operations run before populate operations, the following chain of events will occur:</p>

<ol>
<li>
<p>The element will render in the &#8220;empty&#8221; state, with class &#8220;empty&#8221; applied.</p>
</li>

<li>
<p>If the <code>/users</code> array is empty, it will remain in the empty state</p>
</li>

<li>
<p>If the <code>/users</code> array becomes non-empty:</p>

<ol>
<li>The &#8220;No users found&#8221; element will be stashed</li>

<li>The <code>ul</code> element will be populated using the template</li>

<li>The &#8220;empty&#8221; class will be removed from the <code>ul</code></li>
</ol>
</li>

<li>
<p>If the <code>/users</code> array reverts to an empty state:</p>

<ol>
<li>The &#8220;empty&#8221; class will be removed from the <code>ul</code></li>

<li>The &#8220;No users found&#8221; element will be unstashed into the <code>ul</code>, overwriting the rendered template content.</li>
</ol>
</li>
</ol>

<h1 id='templating_with_mustache'>Templating with Mustache</h1>

<h1 id='you_can_still_write_your_markup_with_ruby'>You can still write your markup with Ruby</h1>

<h1 id='responding_to_state_changes_with_javascript'>Responding to state changes with Javascript</h1>

<h1 id='forcing_links_and_forms_to_load_synchronously'>Forcing links and forms to load synchronously</h1>

<p>To prevent Spah from adding asynchronous behaviour, add the <code>data-async="false"</code> attribute to the link or form element:</p>
<div class='highlight'><pre><span class='nt'>&lt;a</span> <span class='na'>href=</span><span class='s'>&quot;/login&quot;</span> <span class='na'>data-async=</span><span class='s'>&quot;false&quot;</span><span class='nt'>&gt;</span>Log in<span class='nt'>&lt;/a&gt;</span>

<span class='nt'>&lt;form</span> <span class='na'>action=</span><span class='s'>&quot;/login&quot;</span> <span class='na'>method=</span><span class='s'>&quot;POST&quot;</span> <span class='na'>data-async=</span><span class='s'>&quot;false&quot;</span><span class='nt'>&gt;</span>
  ...
<span class='nt'>&lt;/form&gt;</span>
</pre>
</div>
<h1 id='default_client_behaviour'>Default client behaviour</h1>

<h1 id='eager_client_state_changes'>Eager client state changes</h1>

<h1 id='example_rails_application'>Example Rails application</h1>

<h1 id='example_sinatra_application'>Example Sinatra application</h1>
</div> <!-- .section -->

              <div class="section section-sections">
                <div class="section-title">
                  <h3>Sections</h3>
                </div> <!-- .section-title -->
                <div class="section-content">

  <ul class="section-list">
    
  </ul>
              </div> <!-- .section-content -->
            </div> <!-- .section -->

      </div> <!-- #main -->
      
      <div id="footer">
        <p><a href="http://github.com/danski/spah">Spah</a> v0.0.0 API documentation.</p>
        <p>
          
            Last updated on May 07, 2011 at 19:19 UTC.
          
          Generated by <a href="http://pdoc.org">PDoc</a>.
          Uses <a href="http://famfamfam.com/lab/icons/silk/" title="famfamfam.com: Silk Icons">Silk Icons</a> and portions of <a href="http://github.com/280north/aristo/tree/master" title="280north's aristo at master - GitHub">Aristo</a>.
        </p>
        
      </div> <!-- #footer -->

    </div> <!-- #page -->
  </body>
</html>
