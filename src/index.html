<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Spah  v0.0.0 API documentation | Home</title>
  <meta name="generator" content="PDoc" />
  
  <script charset="utf-8" src="javascripts/pdoc/prototype.js" type="text/javascript"></script>
  <script charset="utf-8" src="javascripts/pdoc/application.js" type="text/javascript"></script>
<script charset="utf-8" src="javascripts/pdoc/tabs.js" type="text/javascript"></script>
  <script charset="utf-8" src="javascripts/pdoc/item_index.js" type="text/javascript"></script>
  
  <link charset="utf-8" href="stylesheets/pdoc/api.css" media="screen, projection" rel="stylesheet" type="text/css" />
<link charset="utf-8" href="stylesheets/pdoc/pygments.css" media="screen, projection" rel="stylesheet" type="text/css" />
  
  <script type="text/javascript">
    PDoc.pathPrefix = '';
  </script>
</head>
  <body>

    <div id="sidebar">
      <ul id="sidebar_tabs" class="sidebar-tabs">
        <li>
          <a href="#menu_pane">Menu</a>
        </li>
        <li>
          <a href="#search_pane">Search</a>
        </li>
      </ul> <!-- .sidebar-tabs -->

      <form class="search-ribbon">
        <label>
          <span class="hidden">Search</span>
          <input type="text" id="search" size="20" title="Search" />
        </label>
      </form>
      
      <div class="sidebar-pane scrollable" id="menu_pane">
        <ul class="menu-items" id="api_menu"><li><div class="menu-item"><a class="class" href="Spah/index.html" title="Spah (class)">Spah</a></div><ul><li><div class="menu-item"><a class="class" href="Spah/DOM/index.html" title="Spah.DOM (class)">Spah.DOM</a></div><ul><li><div class="menu-item"><a class="class" href="Spah/DOM/Blueprint/index.html" title="Spah.DOM.Blueprint (class)">Spah.DOM.Blueprint</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/DOM/Document/index.html" title="Spah.DOM.Document (class)">Spah.DOM.Document</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/DOM/Errors/index.html" title="Spah.DOM.Errors (class)">Spah.DOM.Errors</a></div><ul><li><div class="menu-item"><a class="class" href="Spah/DOM/Errors/InvalidModifierError/index.html" title="Spah.DOM.Errors.InvalidModifierError (class)">Spah.DOM.Errors.InvalidModifierError</a></div></li></ul></li>
<li><div class="menu-item"><a class="class" href="Spah/DOM/Modifiers/index.html" title="Spah.DOM.Modifiers (class)">Spah.DOM.Modifiers</a></div><ul><li><div class="menu-item"><a class="class" href="Spah/DOM/Modifiers/ClassName/index.html" title="Spah.DOM.Modifiers.ClassName (class)">Spah.DOM.Modifiers.ClassName</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/DOM/Modifiers/ElementId/index.html" title="Spah.DOM.Modifiers.ElementId (class)">Spah.DOM.Modifiers.ElementId</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/DOM/Modifiers/Show/index.html" title="Spah.DOM.Modifiers.Show (class)">Spah.DOM.Modifiers.Show</a></div></li></ul></li></ul></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/index.html" title="Spah.SpahQL (class)">Spah.SpahQL</a></div><ul><li><div class="menu-item"><a class="class" href="Spah/SpahQL/Callbacks/index.html" title="Spah.SpahQL.Callbacks (class)">Spah.SpahQL.Callbacks</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/DataHelper/index.html" title="Spah.SpahQL.DataHelper (class)">Spah.SpahQL.DataHelper</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Errors/index.html" title="Spah.SpahQL.Errors (class)">Spah.SpahQL.Errors</a></div><ul><li><div class="menu-item"><a class="class" href="Spah/SpahQL/Errors/SpahQLError/index.html" title="Spah.SpahQL.Errors.SpahQLError (class)">Spah.SpahQL.Errors.SpahQLError</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Errors/SpahQLRunTimeError/index.html" title="Spah.SpahQL.Errors.SpahQLRunTimeError (class)">Spah.SpahQL.Errors.SpahQLRunTimeError</a></div></li></ul></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Query/index.html" title="Spah.SpahQL.Query (class)">Spah.SpahQL.Query</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/QueryParser/index.html" title="Spah.SpahQL.QueryParser (class)">Spah.SpahQL.QueryParser</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/QueryResult/index.html" title="Spah.SpahQL.QueryResult (class)">Spah.SpahQL.QueryResult</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/QueryResultSet/index.html" title="Spah.SpahQL.QueryResultSet (class)">Spah.SpahQL.QueryResultSet</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/QueryRunner/index.html" title="Spah.SpahQL.QueryRunner (class)">Spah.SpahQL.QueryRunner</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Token/index.html" title="Spah.SpahQL.Token (class)">Spah.SpahQL.Token</a></div><ul><li><div class="menu-item"><a class="class" href="Spah/SpahQL/Token/Base/index.html" title="Spah.SpahQL.Token.Base (class)">Spah.SpahQL.Token.Base</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Token/Boolean/index.html" title="Spah.SpahQL.Token.Boolean (class)">Spah.SpahQL.Token.Boolean</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Token/ComparisonOperator/index.html" title="Spah.SpahQL.Token.ComparisonOperator (class)">Spah.SpahQL.Token.ComparisonOperator</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Token/FilterQuery/index.html" title="Spah.SpahQL.Token.FilterQuery (class)">Spah.SpahQL.Token.FilterQuery</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Token/KeyName/index.html" title="Spah.SpahQL.Token.KeyName (class)">Spah.SpahQL.Token.KeyName</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Token/Numeric/index.html" title="Spah.SpahQL.Token.Numeric (class)">Spah.SpahQL.Token.Numeric</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Token/PathComponent/index.html" title="Spah.SpahQL.Token.PathComponent (class)">Spah.SpahQL.Token.PathComponent</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Token/SelectionQuery/index.html" title="Spah.SpahQL.Token.SelectionQuery (class)">Spah.SpahQL.Token.SelectionQuery</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Token/Set/index.html" title="Spah.SpahQL.Token.Set (class)">Spah.SpahQL.Token.Set</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Token/Simple/index.html" title="Spah.SpahQL.Token.Simple (class)">Spah.SpahQL.Token.Simple</a></div></li>
<li><div class="menu-item"><a class="class" href="Spah/SpahQL/Token/String/index.html" title="Spah.SpahQL.Token.String (class)">Spah.SpahQL.Token.String</a></div></li></ul></li></ul></li>
<li><div class="menu-item"><a class="class" href="Spah/State/index.html" title="Spah.State (class)">Spah.State</a></div></li></ul></li></ul><!--- #api_menu =-->
      </div> <!-- .sidebar-pane -->
      <div class="sidebar-pane" id="search_pane">
        <ul id="search_results" class="search-results menu-items scrollable"></ul>
      </div> <!-- .sidebar-pane -->
    </div> <!-- #sidebar -->

    <div id="page">
      

      <div id="main" class="page-content">
        

<div class="page-introduction">
  <h1 id='spah_build_awesome_singlepage_apps_without_breaking_the_web'>Spah: Build awesome single-page apps without breaking the web.</h1>

<p>Single-page web apps are awesome. You can use the single-page paradigm to build fancy, stateful web apps that hang right off your service&#8217;s developer API. But it can have terrible side effects.</p>

<p>In the process of putting entire applications on a single URL, we risk breaking the web. We&#8217;re making our pages unfriendly to search engines and impenetrable to microdata clients. We want to get all the advantages and capabilities of rich javascript apps but <em>without</em> the nasty stuff. That means no hashbangs, no code duplication, and no trickery to give search engines and scrapers what they want.</p>

<p>So here&#8217;s Spah. Spah takes the best from both the single- and multi-page paradigms and boils it down to a few core concepts:</p>

<ol>
<li>A <strong>state</strong> for your UI. That&#8217;s a description of which tabs are active, what the user has typed into a form, lists of model objects, user preferences, that sort of thing.</li>

<li>A <strong>blueprint</strong> for the HTML that makes up your application, much like a template. You define how it will react to changes in the <strong>state</strong>.</li>

<li>A <strong>server</strong> that can make changes to the <strong>state</strong>. The server understands your <strong>blueprint</strong> - so if the user enters a URL directly into their browser, the server can apply the <strong>state</strong> to your <strong>blueprint</strong> and deliver proper HTML down the wire. If the user navigates to that URL from within your app, the server can just ship changes to the UI state as plain JSON.</li>

<li>A <strong>client</strong> that adds all the rich single-page behaviours. It keeps the UI synced to changes in the <strong>state</strong>, it manages navigation history and it enables more advanced client-side behaviours such as lazy-loading.</li>
</ol>

<ul>
<li><strong>Be a good web citizen</strong>. With Spah, every URL in your site may be indexed, bookmarked, shared and CURLed just like a web page should.</li>

<li><strong>Progressively enhance</strong>. Once a user with a modern browser has loaded a page from your app, the single-page paradigm takes over and all new data may be loaded asynchronously, without destroying the in-browser state of your page. Users with older browsers - even those without Javascript enabled - get to use your app like its 1999.</li>

<li><strong>Use proper markup</strong>. Spah is not a UI framework. It doesn&#8217;t generate buttons or list views or anything like that. You build the UI and its controls using proper, semantic HTML and Spah helps you keep them synced with the current UI state.</li>

<li><strong>Keep it stateful.</strong> Spah&#8217;s job is to manage the state of your UI and ensure that the markup seen in the user&#8217;s browser matches that state. The state contains everything in your UI, from lists of model objects through to user preferences and unsaved form content. You decide which bits of the state are hard-rendered as HTML and which bits are used to trigger more advanced client-side behaviours, while Spah syncs and updates the state on each call to the server.</li>

<li><strong>Avoid repetition.</strong> Do all this with <em>zero</em> code duplication between client and server. Spah solves the difficult problems of shared client/server templating and state management, leaving you to work on your app.</li>

<li><strong>Use other libraries.</strong> Spah doesn&#8217;t opinionate about client-side model frameworks or REST paradigms or how you authenticate with your API. Spah only cares about JSON, jQuery and having access to a Spah-compatible server. The Spah server is not a full-stack web framework, but a slim library intended to be woven into your wider application stack. To be completely clear: Spah is code that manages the state of a UI in a complex web app, and nothing more. You bring your own app stack preferences to the table.</li>
</ul>

<h1 id='contents'>Contents</h1>

<ol>
<li>
<p><a href='#introduction'>Introduction</a></p>

<ul>
<li><a href='#anatomy_of_a_singlepage_web_app'>Anatomy of a single-page web app</a></li>

<li><a href='#the_state'>The state</a></li>

<li><a href='#anatomy_of_a_spah_web_app'>Anatomy of a spah app</a></li>
</ul>
</li>

<li>
<p><a href='#the_server'>The server</a></p>

<ul>
<li>TODO Document runner</li>

<li>TODO Template handling</li>

<li>TODO Blueprint compiler</li>

<li>TODO State expansion</li>

<li>TODO Default states</li>
</ul>
</li>

<li>
<p><a href='#the_client'>The client</a></p>

<ul>
<li>TODO Document runner</li>

<li>TODO Template handling</li>

<li>TODO Event handling</li>

<li>TODO Link, form and navigation handling</li>

<li>TODO History management</li>

<li>TODO State reduction</li>
</ul>
</li>

<li>
<p><a href='#spahql'>Querying the state with SpahQL</a></p>

<ul>
<li><a href='#spahql_core_concepts'>Core concepts</a></li>

<li><a href='#selection_queries'>Selection queries</a></li>

<li><a href='#assertion_queries'>Assertion queries</a></li>

<li><a href='#assertion_queries_literals_and_sets'>Literals and sets</a></li>

<li><a href='#comparison_operators'>Comparison operators</a></li>

<li><a href='#object_equality'>Object equality</a></li>
</ul>
</li>

<li>
<p><a href='#document_logic'>Document logic</a></p>

<ul>
<li><a href='#hide_or_show_an_element'>Hiding and showing elements</a></li>

<li><a href='#add_or_remove_element_classes'>Adding and removing element classes</a></li>

<li><a href='#set_element_id'>Setting the ID of an element</a></li>

<li><a href='#stash_and_unstash_element_content'>Stash and unstash element content</a></li>

<li><a href='#using_multiple_operations_on_a_single_element'>Using multiple operations on a single element</a></li>

<li>TODO: Applying document logic with css selectors ({&#8220;a.loadsTickets&#8221;: {&#8220;stash-if&#8221;: &#8220;query&#8221;}})</li>

<li><a href='#advanced_document_logic_example'>Advanced example</a></li>

<li>TODO: Extending Spah with your own document modifiers</li>
</ul>
</li>

<li>
<p>TODO: <a href='#templating_with_mustache'>Templating with Mustache</a> * TODO: Extending the template helpers</p>
</li>

<li>
<p>TODO: <a href='#responding_to_state_changes_with_javascript'>Reacting to state changes with Javascript</a></p>
</li>

<li>
<p><a href='#forcing_links_and_forms_to_load_synchronously'>Forcing links and forms to load synchronously</a></p>
</li>

<li>
<p>TODO: <a href='#default_client_behaviour'>Default client behaviours</a> (automatically update doc title from /title path, automatically add async behaviour, automatically manage history)</p>
</li>

<li>
<p>TODO: <a href='#eager_client_state_changes'>Eager client state changes</a> (mark parts of the tree as &#8220;expected to get new data&#8221; to trigger load notifications. automatically revert to previous state on load failure and dispatch failure event)</p>
</li>

<li>
<p>TODO: <a href='#example_node_application'>Examples: Example Node.js application</a></p>
</li>

<li>
<p>TODO: <a href='#example_sinatra_application'>Examples: Example Sinatra application</a></p>
</li>
</ol>

<h1 id='introduction'>Introduction</h1>

<p>Spah is a set of libraries designed to permit the development of a specific class of web application - one in which the majority of URLs absolutely must be fetchable as a generic HTML document for purposes of indexing and scraping, while maintaining highly responsive, stateful behaviour in the browser. It is also assumed that you, the developer, wish for a happy life and therefore do not want to duplicate any code, anywhere.</p>

<p>To be clear, Spah is <em>not</em> a full-stack web framework like Rails or Django. Nor is it UI framework like Sproutcore or Cappucino. Spah has no model objects, validation helpers, database connection managers, or request routers. Spah doesn&#8217;t care what you use to do your routing or your persistence. <strong>All Spah cares about is delivering highly stateful pages - it is a view layer for your application, nothing more</strong>. Here&#8217;s what makes up Spah:</p>

<ul>
<li><em>A client</em>. The Spah Client forms the backbone of your browser-based UI. It incorporates all the trickery needed to keep the state of your UI synced up and to help the user navigate your application.</li>

<li><em>A server</em>. The Spah Server is a Node.js library designed to be hooked into any web framework you like. You use the Spah Server to make changes to the state of your UI and to serve those changes back to the user.</li>

<li><em>A query language</em>. SpahQL is a query language for JSON. It allows you to pull data out of JSON objects and to make assertions about their contents. SpahQL is really the backbone of Spah&#8217;s functionality.</li>
</ul>

<p>Spah is written entirely in Javascript, and designed to run in both the browser and via a Node.js server.</p>

<p>To best explain how Spah works, it&#8217;s probably best to start by looking at some other patterns for building these desktop-class web apps in order to show the decisions that drove Spah&#8217;s creation.</p>

<h2 id='anatomy_of_a_singlepage_web_app'>Anatomy of a single-page web app</h2>

<h3 id='figure_1_the_most_simple_web_app'>Figure 1: The most simple web app</h3>
<img src='https://img.skitch.com/20110720-mnf4xun1n6gwf461edtp12jmjf.jpg' />
<p>We all recognise this. The server renders pages as they are requested and serves them in the body of a request. As far as the client is concerned, it&#8217;s pulling static HTML. It has these qualities:</p>

<ul>
<li><em>Good</em>: Every page is indexable and scrapable in every possible state.</li>

<li><em>Good</em>: Since the state of the page is handled exclusively by the server, state can be maintained as the user navigates between pages.</li>

<li><strong>Bad</strong>: Since the state of the page is handled exclusively by the server, maintaining state requires the developer to wrangle highly complicated query strings.</li>

<li><strong>Bad</strong>: The page is expected to load with all the content it could possibly need. Response times can suffer as a result.</li>
</ul>

<h3 id='figure_2_singlepage_apps_or_how_we_learned_to_stop_worrying_and_tolerate_hashbangs'>Figure 2: Single-page apps (or: how we learned to stop worrying and tolerate hashbangs)</h3>
<img src='https://img.skitch.com/20110504-73a3ftde7d731kbepxg2p7w1.jpg' />
<p>This approach yields the much-desired &#8220;desktop&#8221; class of application, and it&#8217;s a tempting approach for any app that also provides a comprehensive JSON API. But, in adopting this approach, we&#8217;ve made some serious concessions:</p>

<ul>
<li><em>Good</em>: The whole UI runs within a single page, so you can have multiple complex stateful UI elements that retain their state as the rest of the page is updated.</li>

<li><em>Good</em>: The whole UI runs within the browser, so you&#8217;ve got templating handled in the client. No duplication of template code.</li>

<li><em>Bad</em>: It needs a browser to run. You can&#8217;t deliver markup for non-browser requests without creating an HTML rendering chain on the server.</li>

<li><em>Bad</em>: We&#8217;re not indexable any more. Your app only has one URL, and it serves boilerplate contentless markup. If you decide to make your URLs server-renderable, then the spectre of code duplication returns.</li>

<li><em>Bad</em>: Response times suffer, but not because of server inefficiencies such as those seen in Figure 1. Instead, we introduce multiple HTTP turnarounds to start the app - one to load the page, several more to populate it with content.</li>
</ul>

<h2 id='the_state'>The State</h2>

<h2 id='anatomy_of_a_spah_web_app'>Anatomy of a Spah web app</h2>

<h1 id='the_server'>The server</h1>

<p>A Spah server is assumed to be a resource-centric Node.js or Sinatra application. As always, all validation and data persistence is handled on the server side by your app&#8217;s models. All routing will be in your app&#8217;s router, and all request logic in its controllers. Where a Spah app differs is in the view layer.</p>

<p>Instead of hiding away template logic in server-side code, template logic is moved to a place where both the client AND the server have access to it - <a href='#document_logic'>the document itself</a>.</p>

<p>A Spah HTML render takes the <strong>state</strong> and a <strong>prototype layout</strong> and gloms to the two together. The HTML layout contains <a href='#document_logic'>logic encoded in HTML5 data attributes</a>, and Spah will pre-process the document <strong>before sending it down the wire</strong>. This way, any view can be cold-rendered by a request to the appropriate URL, or warm-rendered by an asynchronous state update from the server. In a sense, Spah allows your server-side app to <em>behave like a browser</em> and boot your client-side application to the point of usefulness, before letting the user&#8217;s actual browser carry out the rest of the startup process.</p>

<p><em>Figure 2: A better approach.</em></p>
<img src='https://img.skitch.com/20110504-p13hfga9s4d6x7bpjwrw1gbyjj.jpg' />
<p>For partials, Spah uses <a href='#templating_with_mustache'>Mustache templates</a>. All <code>.mustache</code> files in your server-side application are indexed by path on startup and made available to the rendering chain on both the client and server. Spah automatically injects the templates into your HTML layout using script tags:</p>

<p>These are semantically neutral in nature and do not alter your document&#8217;s content. Spah will also add a hidden <code>state</code> input to the end of each form in your document containing the current state, and append the state to link URLs within the current domain - this allows for graceful state handover in no-js environments.</p>

<p>In environments that support JS, the state in forms and links is replaced with the current state on submission/activation.</p>

<h1 id='the_client'>The client</h1>

<p>The Spah client handles things at the browser end. Its primary tasks are:</p>

<ol>
<li>Ensuring that links and forms are submitted asynchronously and that they attach the state when activated (you may also <a href='#forcing_links_and_forms_to_load_synchronously'>prevent some links and forms from acting asynchronously</a>)</li>

<li>Ensuring that async requests are submitted with a <code>content-accept</code> header of <code>application/state+json</code>, allowing the server-side application to determine that this is a warm request and should be responded to with an updated state</li>

<li>Re-evaluating and processing any document logic whenever the state is modified</li>

<li>Raising path-specific events whenever the state is modified</li>
</ol>

<p><em>Figure 3: A better approach, with added progressive enhancement</em></p>
<img src='https://img.skitch.com/20110504-tpqb613eyy46j7f758nqr745n2.jpg' />
<p>This is achieved by embedding template logic within the markup using HTML5 data attributes, thus making the same template logic available to both client and server. When the state is updated by a response from the server, elements with embedded display logic are re-evaluated automatically and the display updated accordingly.</p>

<p>You may also bind more advanced behaviours to changes in the state using <a href='#responding_to_state_changes_with_javascript'>jQuery responders</a> and <a href='#spahql'>state queries</a></p>

<p>For cleanliness, Spah keeps all of its functions, classes and behaviour within the top level <code>Spah</code> object. Initialising Spah is simple:</p>

<h1 id='spahql'>SpahQL</h1>

<h2 id='spahql_core_concepts'>SpahQL Core concepts</h2>

<p>SpahQL is an execution-safe query language designed to let you ask complex questions of basic JSON constructs. SpahQL is designed to work against your application&#8217;s state, but it will work happily against any combination of native hashes, arrays, strings, booleans and numbers.</p>

<p>SpahQL allows two kinds of query: <strong><a href='#selection_queries'>Selection queries</a></strong> are those which retrieve a set of results from your object, while <strong><a href='#assertion_queries'>Assertion queries</a></strong> are those that return a boolean result.</p>

<p>SpahQL is biased towards value equality over key equality. It is assumed that the keys in your object are known, curated namespace with arbitrary values. For this reason SpahQL&#8217;s matching is designed to focus on comparing values, not keys.</p>

<p>All SpahQL queries are read-only; there is no semantic for updating the state.</p>

<p>Furthermore, SpahQL uses set arithmetic for comparisons. Rather than providing an imperative syntax with complex logic, SpahQL provides set operations that allow you to build the equivalent of the <code>AND</code> and <code>OR</code> operations from other query languages using a safe, declarative syntax.</p>

<h2 id='selection_queries'>Selection queries</h2>

<p>To select items from the state, use the basic syntax:</p>

<p>The basic constituent of a selection query is a <em>path selector</em>. With an example object:</p>

<p>It&#8217;s easy to make selections based on a known path. To pull up the contents of the key &#8220;myHash&#8221; in the root, use the following syntax and remember that <strong>paths always begin with a slash</strong>.</p>

<p>Or to pull up the contents of the subhash:</p>

<p>Recursion is supported with a double-slash anywhere in the path:</p>

<p>The results are always returned as a set of <code>Spah.SpahQL.QueryResult</code> objects, which each have properties <code>path</code> and <code>value</code>:</p>

<p>Keys in arrays are treated just like keys in hashes:</p>

<p>You may also use <code>*</code> as a wildcard in paths:</p>

<p>Path queries are <strong>reductive</strong>. When executed, the first part of the query is run against the top level of the object being queried, and the remaining results are handed to the next part of the path to be reduced further. This loop continues until we&#8217;re either out of results or out of path segments.</p>

<p>Using these reductive characteristics, we can perform advanced queries with <strong>filter queries</strong>. Filter queries are contained in square brackets, and can be used to further reduce the results before the query runner moves on to the next path segment.</p>

<p>There are a few things to note about the query inside the <code>[]</code> brackets. Firstly, it has access to the full query syntax. Secondly, it runs within the scope of the current path segment. Take this query for example:</p>

<p>If you want to lookup data on the root from inside a filter query, use the <code>$</code> symbol to force a path to execute on the root context:</p>

<p>I&#8217;m sure by now that you&#8217;ve noticed the filter queries contain <strong>comparison operators</strong>. Any query containing a comparison operator is automatically executed as an <a href='#assertion_queries'>assertion query</a>:</p>

<ul>
<li>
<p>A <strong>selection</strong> query:</p>

<pre><code>  /myHash</code></pre>
</li>

<li>
<p>An <strong>assertion</strong> query:</p>

<pre><code>  /myHash == /someOtherHash</code></pre>
</li>

<li>
<p>A <strong>selection</strong> query containing an assertion query as a filter:</p>

<pre><code>  /myHash[/foo == &#39;baz&#39;]</code></pre>
</li>

<li>
<p>An <strong>assertion</strong> query containing two selection queries, one of which contains an assertion query as a filter:</p>

<pre><code>  /myHash[/foo == &#39;baz&#39;] == /myArr</code></pre>
</li>
</ul>

<h2 id='assertion_queries'>Assertion queries</h2>

<p>We&#8217;ve already seen how assertion queries can be used as filters in <a href='#selection_queries'>selection queries</a>. Assertion queries are also used heavily in Spah&#8217;s <a href='#document_logic'>document logic</a> features.</p>

<p>Assertion queries are run through the <code>assert</code> method on the state:</p>

<p>The <code>assert</code> method accepts both selection and assertion queries - if the given query is a selection query, the result will be <code>true</code> if the query returns one or more results with non-false (i.e. not false or null) values.</p>

<p>As discussed in <a href='#spahql_core_concepts'>core concepts</a>, all comparisons in SpahQL use set arithmetic instead of traditional imperative logic and equality. SpahQL comparisons allow you to determine if:</p>

<ul>
<li>One set is exactly equal to another set</li>

<li>One set contains the same values as another set</li>

<li>One set is a subset of another set</li>

<li>One set is a superset of another set</li>
</ul>

<h2 id='assertion_queries_literals_and_sets'>Assertion queries: Literals and sets</h2>

<p>SpahQL does support literals - strings, integers, floats, <code>true</code>, <code>false</code> and <code>null</code> may all be used directly in SpahQL queries:</p>

<p>All comparisons in SpahQL are <strong>set comparisons</strong>. A query like <code>/foo</code> returns a set of results. A literal like <code>3</code> or <code>"somestring"</code> is considered to be a set containing a single entity. Literals may be wrapped in <code>{}</code> mustaches and seperated with commas to create in-place sets:</p>

<p>Sets may also be built from a combination of literals and queries:</p>

<p>You may also create ranges:</p>

<h2 id='comparison_operators'>Comparison operators</h2>

<p>SpahQL&#8217;s set arithmetic uses simple operators:</p>

<ul>
<li>
<p>Set equality <code>==</code></p>

<p>Asserts that both the left-hand and right-hand sets have a 1:1 relationship between their values. The values may come from different paths in the state, or be literals. The values do not have to be in the same order. Each value has its equality checked based on its type. See <a href='#object_equality'>Object equality</a>.</p>
</li>

<li>
<p>Set inequality <code>!=</code></p>

<p>Asserts that the sets are not identical under the rules of the <code>==</code> operator.</p>
</li>

<li>
<p>Subset of <code>}&lt;{</code></p>

<p>Asserts that the left-hand set is a subset of the right-hand set. All values present in the left-hand set must have a matching counterpart in the right-hand set.</p>
</li>

<li>
<p>Superset of <code>}&gt;{</code></p>

<p>Asserts that the left-hand set is a superset of the right-hand set. All values present in the right-hand set must have a matching counterpart in the left-hand set.</p>
</li>

<li>
<p>Joint set <code>}~{</code></p>

<p>Asserts that the left-hand set contains one or more values that are also present in the right-hand set.</p>
</li>

<li>
<p>Disjoint set <code>}!{</code></p>

<p>Asserts that the left-hand set contains no values that are also present in the right-hand set.</p>
</li>

<li>
<p>Rough equality <code>=~</code></p>

<p>Asserts that one or more values from the left-hand set are roughly equal to one or more values from the right-hand set. See <a href='#object_equality'>Object equality</a>.</p>
</li>

<li>
<p>Greater than (or equal to) <code>&gt;=</code> and <code>&gt;</code></p>

<p>Asserts that one or more values from the left-hand set is greater than (or equal to) one or more values from the right-hand set.</p>
</li>

<li>
<p>Less than (or equal to) <code>&lt;=</code> and <code>&lt;</code></p>

<p>Asserts that one or more values from the left-hand set is less than (or equal to) one or more values from the right-hand set.</p>
</li>
</ul>

<h2 id='object_equality'>Object equality</h2>

<p>The equality of objects is calculated based on their type. Firstly, for two objects to be equal under strict equality (<code>==</code>) they must have the same base type.</p>

<ul>
<li><strong>Object equality</strong>: The objects being compared must contain the same set of keys, and the value of each key must be the same in each object. If the value is an object or an array, it will be evaluated recursively.</li>

<li><strong>Array equality</strong>: The arrays must each contain the same values in the same order. If any value is an array or object, it will be evaluated recursively.</li>

<li><strong>Number, String, Bool, null</strong>: The objects must be of equal type and value.</li>
</ul>

<p>Under rough equality (<code>=~</code>) the rules are altered:</p>

<ul>
<li><strong>Strings</strong> are evaluated to determine if the left-hand value matches the right-hand value, evaluating the right-hand value as a regular expression e.g. <code>"bar" =~ "^b"</code> returns <code>true</code> but <code>"bar" =~ "^a"</code> returns <code>false</code></li>

<li><strong>Numbers</strong> are evaluated with integer accuracy only (using Math.floor, numeric.floor or an equivalent operation)</li>

<li><strong>Arrays</strong> behave as if compared with the joint set operator.</li>

<li><strong>Objects</strong> are roughly equal if both hashes contain one or more keys with the same corresponding values. Values are compared using strict equality.</li>

<li><strong>Booleans and null</strong> are evaluated based on truthiness rather than exact equality. <code>false =~ null</code> is <code>true</code> but <code>true =~ false</code> is <code>false</code>.</li>
</ul>

<p>N.B: Objects that are of different types are never roughly equal.</p>

<p>When using inequality operators <code>&lt;</code>, <code>=&lt;</code>, <code>&gt;</code>, <code>&gt;=</code>:</p>

<ul>
<li><strong>Strings</strong> are evaluated based on alphanumeric sorting. <code>"a" &lt;= "b"</code> returns <code>true</code> but <code>"z" &gt;= "a"</code> returns <code>false</code>.</li>

<li><strong>Numbers</strong> are evaluated, as you&#8217;d expect, based on their native values.</li>

<li><strong>Arrays, Objects, Booleans, null</strong> are not compatible with these operators and will automatically result in <code>false</code> being returned.</li>
</ul>

<h2 id='properties'>Properties</h2>

<p>Properties are like imaginary paths on objects in your state. Each property uses the <code>.propertyName</code> syntax and may be used in any path query:</p>

<ul>
<li>
<p><strong>.type</strong> Returns the object type as &#8216;Object&#8217;, &#8216;Array&#8217;, &#8216;String&#8217;, &#8216;Number&#8217;, &#8216;Boolean&#8217; or &#8216;null&#8217;</p>
</li>

<li>
<p><strong>.size</strong> Returns the object&#8217;s size if it is a String (number of characters), Array (number of items) or Object (number of keys)</p>

<pre><code>  // Number of keys in the root
  results = Spah.state.select(&quot;/.size&quot;);
  results[0].path //-&gt; &quot;/.size&quot;
  results[0].value //-&gt; 3
  
  // Find all strings longer than 3 characters
  results = Spah.state.select(&quot;//[/.type == &#39;String&#39;][/.size &gt; 3]&quot;)
  results[0].path //-&gt; &quot;/myHash/mySubHash/bar&quot;</code></pre>
</li>

<li>
<p><strong>.explode</strong> Returns the object broken into a set that may be compared to other sets. Strings are exploded into a set of characters. Arrays and objects do not support this property - use the wildcard (*) character instead.</p>
</li>
</ul>

<h1 id='document_logic'>Document logic</h1>

<p>In a Spah application, document logic (show this, hide that, populate this with that) is moved away from in-place Erb views and into a place where both the client and the server will have access to it - the document itself. In doing this, we want to avoid doing anything silly like adding new tags or attributes that break HTML validity, or dirtying up your markup with billions of extra nested div elements.</p>

<p>Spah handles document logic with HTML5 data attributes. Elements may query the state and declare how they should be altered when the query result is returned. When cold-booting your application from the server, the document logic is evaluated and run in-place before sending the HTML down the wire - this is what allows Spah to respond to HTML requests with valid, useful documents. On the client side, updates to the state cause any embedded document logic to be re-evaluated automatically. All document logic is achieved using <a href='#spahql'>State Queries</a>. Conditions such as <code>if</code> statements use truthiness queries, as seen in the <a href='#assertion_queries'>state query documentation</a>.</p>

<p>Spah provides the following operations on document logic:</p>

<h2 id='hide_or_show_an_element'>Hide or show an element</h2>

<p>Show/hide of an element is achieved by appending <code>display: none;</code> to the element&#8217;s <code>style</code> attribute if it should be hidden.</p>

<h2 id='add_or_remove_element_classes'>Add or remove element classes</h2>

<p>Use the <code>data-class-[classname]-if</code> or <code>-unless</code> attribute to specify that a specific class should be appended to the element&#8217;s <code>class</code> attribute.</p>

<pre><code>&lt;li class=&quot;item&quot; data-class-current-if=&quot;/items[0]/important&quot;&gt;
  This list item will have the class &quot;important&quot; if the first item in the 
  array at &quot;/items&quot; has the &quot;important&quot; property
&lt;/li&gt;</code></pre>

<h2 id='set_element_id'>Set element ID</h2>

<p>Use the <code>data-id-[id]-if</code> or <code>-unless</code> to specify that an element should be given a new <code>id</code> under certain circumstances. If the condition causes Spah to write the ID on an element, Spah will automatically remove the ID from any other elements that previously possessed it.</p>

<h2 id='stash_and_unstash_element_content'>Stash and unstash element content</h2>

<p>Stashing content allows you to render semantically-null empty elements into your document, with their content stowed in a data attribute for later use. Stashing only occurs if there is no content already stashed on the element - thus stashed content may be used for state-toggling. See <a href='#advanced_document_logic_example'>example</a>.</p>

<h2 id='populate_element_from_a_template'>Populate element from a template</h2>

<p>Spah can use your shared <a href='#templating_with_mustache'>Mustache templates</a> to render state data into a containing element. On the client side, the Spah client will automatically add a <a href='#responding_to_state_changes_with_javascript'>jQuery responder</a> to the path referenced in the <code>data-populate-with</code> attribute, ensuring that the populated content is updated when the state is modified.</p>

<h2 id='using_multiple_operations_on_a_single_element'>Using multiple operations on a single element</h2>

<p>All of the above operations may be combined on a single element. The order in which the operations will run is strictly defined in order of the type of operation. <code>-if</code> operations always run before <code>-unless</code> operations.</p>

<ol>
<li>data-show-if and data-show-unless</li>

<li>data-class-[classname]-if, data-class-[classname]-unless</li>

<li>data-id-[id]-if, data-id-[id]-unless</li>

<li>data-stash-if, data-stash-unless</li>

<li>data-populate-if, data-populate-unless</li>
</ol>

<h2 id='advanced_document_logic_example'>Advanced document logic example</h2>

<p>Let&#8217;s make an advanced example: We want a list of users to default to an &#8220;empty&#8221; state, becoming populated with users if there is a non-empty list of users in the state. If the user list in the state is emptied, then the &#8220;empty&#8221; state should be restored on the element</p>

<p>Because stash operations run before populate operations, the following chain of events will occur:</p>

<ol>
<li>
<p>The element will render in the &#8220;empty&#8221; state, with class &#8220;empty&#8221; applied.</p>
</li>

<li>
<p>If the <code>/users</code> array is empty, it will remain in the empty state</p>
</li>

<li>
<p>If the <code>/users</code> array becomes non-empty:</p>

<ol>
<li>The &#8220;No users found&#8221; element will be stashed</li>

<li>The <code>ul</code> element will be populated using the template</li>

<li>The &#8220;empty&#8221; class will be removed from the <code>ul</code></li>
</ol>
</li>

<li>
<p>If the <code>/users</code> array reverts to an empty state:</p>

<ol>
<li>The &#8220;empty&#8221; class will be removed from the <code>ul</code></li>

<li>The &#8220;No users found&#8221; element will be unstashed into the <code>ul</code>, overwriting the rendered template content.</li>
</ol>
</li>
</ol>

<h1 id='templating_with_mustache'>Templating with Mustache</h1>

<h1 id='responding_to_state_changes_with_javascript'>Responding to state changes with Javascript</h1>

<h1 id='forcing_links_and_forms_to_load_synchronously'>Forcing links and forms to load synchronously</h1>

<p>To prevent Spah from adding asynchronous behaviour, add the <code>data-async="false"</code> attribute to the link or form element:</p>

<h1 id='default_client_behaviour'>Default client behaviour</h1>

<h1 id='eager_client_state_changes'>Eager client state changes</h1>

<h1 id='example_node_application'>Example Node application</h1>

<h1 id='example_sinatra_application'>Example Sinatra application</h1>
</div> <!-- .section -->

              <div class="section section-sections">
                <div class="section-title">
                  <h3>Sections</h3>
                </div> <!-- .section-title -->
                <div class="section-content">

  <ul class="section-list">
    
  </ul>
              </div> <!-- .section-content -->
            </div> <!-- .section -->

      </div> <!-- #main -->
      
      <div id="footer">
        <p><a href="http://github.com/danski/spah">Spah</a> v0.0.0 API documentation.</p>
        <p>
          
            Last updated on March 02, 2012 at 17:47 UTC.
          
          Generated by <a href="http://pdoc.org">PDoc</a>.
          Uses <a href="http://famfamfam.com/lab/icons/silk/" title="famfamfam.com: Silk Icons">Silk Icons</a> and portions of <a href="http://github.com/280north/aristo/tree/master" title="280north's aristo at master - GitHub">Aristo</a>.
        </p>
        
      </div> <!-- #footer -->

    </div> <!-- #page -->
  </body>
</html>
